<!DOCTYPE html>
<head>
	<%- include(root + '/views/template/header.ejs') %>
  	<link rel="stylesheet" href="/source/css/main.css">
	<script src="/source/js/main.js"></script>
</head>

<body>
	<div class="flex h-full w-full bg-[#191920] text-white">
		<%- include(root + '/views/template/content.ejs') %> 
		<div class=" h-full max-w-full flex-1">
			<%- include(root + '/views/template/navbar.ejs') %>
			<div class="flex-1 h-full w-full flex flex-col">
				<div class="flex-1">
					<input type="text" id="abc" class="text-black">
					<button type="" class="btn btn-primary" id="sm">Done</button>
				</div>
				<div class="">
				</div>
			</div>
		</div>
	</div>
	<script src="/generator/rsa.js"></script>
	<script>
		function rsa(cmd, text = "", p=0, q=0) {
			stringToAscii(cmd + '\0' + text, 0);
			//stringToAscii(text, cmd.length + 1);
			//console.log(cmd, text, p, q);
			return UTF8ToString(Module._execute(cmd, text, p.toString(), q.toString()));
		}
		var keyRSA = {};
		window.onload = async () => {

			fetch('https://api.ipify.org?format=json')
		.then(response => response.json())
		.then(data => {
			console.log('Your Public IP Address:', data.ip);
		})
		.catch(error => {
			console.error('Error fetching IP:', error);
		});
			
			const res = await JSON.parse(rsa("create"));
			keyRSA.rec = res;
			console.log(res);

			/*const text = "bulul hoc sinh";
			const encrypt = await rsa("encrypt", text, res.e, res.n);
			console.log("done ", encrypt);

			const decrypt = await rsa("decrypt", encrypt, res.d, res.n);
			console.log("done ", decrypt);*/

			await fetch('/api/trade', {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({n: keyRSA.rec.n, e: keyRSA.rec.e})
			})
			.then(async (response) => {
				if (!response.ok) {
					if (response.status === 404) {
						throw new Error(await response.text());
					}
					else {
						let text = await response.text();
						let json_data = await rsa("decrypt", text, keyRSA.rec.d, keyRSA.rec.n);
						let data = await JSON.parse(json_data);
						keyRSA = data;
						throw new Error("Verified");
					}
				}
				let text = await response.text();
				console.log(text);
				return rsa("decrypt", text, keyRSA.rec.d, keyRSA.rec.n);
			}).then((data) => {
				console.log(data);
				return JSON.parse(data);
			}).then(async (data) => {
				keyRSA.send = data;
				console.log(keyRSA);
			}).then(async () => {

				console.log("exchange");
				let text = await rsa("encrypt", await JSON.stringify(keyRSA.rec), keyRSA.send.e, keyRSA.send.n);

				fetch('/api/trade-v2', {
					method: "POST",
					headers: {
						"Content-Type": "application-json"
					},
					body: JSON.parse({data: text})
				}).then(async(response) => {
					if (!response.ok) {
						throw new Error("Error");
					}
					let text = await response.text();
					return rsa("decrypt", text, keyRSA.rec.d, keyRSA.rec.n);
				}).then(data => {
					console.log(data);
				}).catch(err => {
					console.log(err.message);
				});

			})
			.catch(e => {
				console.log(e.message);
			});
		};
	</script>
	<script>
		async function send_message(text) {
			var cur = await rsa("encrypt", text, keyRSA.send.e, keyRSA.send.n);
			console.log(cur);
			await fetch('/api/messages', {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({content: cur})
			});
		}
		$("#sm").click(function() {
			send_message($("#abc").val());
		});
	</script>
	<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
	<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>